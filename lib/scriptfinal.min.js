var isGetUserMediaSupported=!1,isLocalStorageSupported=!1,isGeoLocationSupported=!1,isTouchSupported=!1,isVibrationSupported=!1,isOrientationSupported=!1,isAppCacheSupported=!1,isMeterSupported=!1,isWebRTCSupported=!1,isBatterySupported=!1,isMediaDevicesSupported=!1,isSafari=!1,GOOGLE_API_KEY="AIzaSyBYE5sFTGdc4L3lp9Qe_N2wxtFRl26UKzQ";window.onload=function(){checkSupportedFeature();configCamera();configLocation();configBattery();getLocalSavedBlogs()};
function checkSupportedFeature(){var a="";Modernizr.getusermedia?isGetUserMediaSupported=!0:a="Get User Media(access to Camera)";Modernizr.localstorage?isLocalStorageSupported=!0:a=(""==a?"":a+", ")+"Local Storage";Modernizr.geolocation?isGeoLocationSupported=!0:a=(""==a?"":a+", ")+"Geo Location";Modernizr.touchevents?isTouchSupported=!0:a=(""==a?"":a+", ")+"Touch Events (Gestures)";Modernizr.vibrate?isVibrationSupported=!0:a=(""==a?"":a+", ")+"Vibration";Modernizr.deviceorientation?isOrientationSupported=
!0:a=(""==a?"":a+", ")+"Device Orientation";Modernizr.applicationcache?isAppCacheSupported=!0:a=(""==a?"":a+", ")+"Application Cache (Offline Capability)";Modernizr.meter?isMeterSupported=!0:a=(""==a?"":a+", ")+"Meter";Modernizr.peerconnection?isWebRTCSupported=!0:a=(""==a?"":a+", ")+"RTC Peer Connection (Camera Stream)";navigator.getBattery?isBatterySupported=!0:a=(""==a?"":a+", ")+"Battery";navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?isMediaDevicesSupported=!0:a=(""==a?"":a+
", ")+"Enumerate Devices";if(""!=a){var b=document.getElementById("invalidFeatureLabel"),c=document.getElementById("invalidFeatureDiv");b.textContent=a+" are not supported in this browser or device.";c.style.display="block"}a=navigator.userAgent.toLowerCase();-1!=a.indexOf("safari")&&0>a.indexOf("chrome")&&(isSafari=!0)}
var width=320,height=0,size=0,direction=0,isStreaming=!1,video=null,canvas=null,photo=null,photobutton=null,photobutton2=null,addBlog=null,textArea=null,imageData=null,previewDiv=null;
function configCamera(){!0===isGetUserMediaSupported&&(video=document.getElementById("video"),canvas=document.getElementById("canvas"),photo=document.getElementById("photo"),photobutton=document.getElementById("photoButton"),photobutton2=document.getElementById("photoButton2"),addBlog=document.getElementById("submit"),textArea=document.getElementById("text"),previewDiv=document.getElementById("previewDiv"),selectCamera(),configOrientation())}
function selectCamera(){var a={video:!0,audio:!1};if(!0===isMediaDevicesSupported){var b=[];navigator.mediaDevices.enumerateDevices().then(function(c){c.forEach(function(a){"videoinput"==a.kind&&b.push(a.deviceId)});null!=b&&0<b.length&&(a={video:{deviceId:{exact:b[b.length-1]}},audio:!1});startPreview(a)})["catch"](function(b){console.log(b.name+": "+error.message);startPreview(a)})}else startPreview(a)}
function startPreview(a){null==navigator.mediaDevices&&(navigator.mediaDevices=navigator.mediaDevices||navigator.webkitMediaDevices||navigator.mozMediaDevices||navigator.msMediaDevices);navigator.mediaDevices.getUserMedia(a).then(function(a){!0===isSafari?video.srcObject=a:video.src=(window.URL||window.webkitURL).createObjectURL(a)})["catch"](function(a){console.log(a)});video.addEventListener("canplay",function(a){isStreaming||(height=video.videoHeight/(video.videoWidth/width),video.setAttribute("width",
width),video.setAttribute("height",height),size=Math.max(height,width),canvas.setAttribute("width",size),canvas.setAttribute("height",size),previewDiv.style.width=size+"px",previewDiv.style.height=size+"px",isStreaming=!0)},!1);photobutton.addEventListener("click",function(a){takepicture();a.preventDefault()},!1);photobutton2.addEventListener("click",function(a){takepicture();a.preventDefault()},!1);clearPhoto()}
function clearPhoto(){var a=canvas.getContext("2d");a.fillStyle="#AAA";a.fillRect(0,0,size,size);a=canvas.toDataURL("image/png");photo.setAttribute("src",a)}
function takepicture(){if("none"!==video.style.display){var a=size/2,b=45<direction?90:-45>direction?-90:0,c=canvas.getContext("2d"),d=0,f=0;0!=b&&(canvas.height=width,canvas.width=height,height>width?d=0<b?0:height-width:f=0<b?width-height:0);c.save();c.translate(a,a);c.rotate(b*Math.PI/180);c.translate(-a,-a);c.drawImage(video,d,f,video.width,video.height);c.restore();a=canvas.toDataURL("image/png");photo.setAttribute("src",a);imageData=a;previewMode(!1)}else previewMode(!0)}
function previewMode(a){!0===a?(video.style.display="block",photo.style.display="none",photobutton.textContent="Take photo",photobutton2.textContent="Take photo",imageData=null,canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height)):(video.style.display="none",photo.style.display="block",photobutton.textContent="Re-take",photobutton2.textContent="Re-take")}
function configOrientation(){isOrientationSupported&&window.addEventListener("deviceorientation",function(a){a.gamma&&(a=parseInt(a.gamma),isNaN(a)||(direction=a))},!0)}var blogs=[],noBlogLabel=null,blogDiv=null;
function addNewBlog(){var a={imageData:imageData,text:textArea.value,location:null==locationInput.value||""==locationInput.value?"Unkonwn":locationInput.value,battery:0<=batteryLevel?batteryLevel:"Unknown"};blogs=blogs||[];blogs.push(a);hideNoBlogLabel();a=createBlogRow(a,blogs.length-1);blogDiv.appendChild(a);saveDataToLocalStorage();previewMode(!0);textArea.value=""}
function hideNoBlogLabel(){null==noBlogLabel&&(noBlogLabel=document.getElementById("noBlog"));"none"!==noBlogLabel.style.display&&(noBlogLabel.style.display="none");null==blogDiv&&(blogDiv=document.getElementById("blogDiv"))}
function createBlogRow(a,b){var c=document.createElement("div");c.setAttribute("class","blog-row");var d=document.createElement("div");d.setAttribute("class","blog-row-wrapper");var f=document.createElement("div");f.setAttribute("class","blog-image-div");var g=document.createElement("img");g.setAttribute("class","blog-image");g.setAttribute("src",null==a.imageData?"default.jpg":a.imageData);var e=document.createElement("div");e.setAttribute("class","blog-content-div");var h=document.createElement("label");
h.setAttribute("class","blog-content");h.textContent=a.text;var k=document.createElement("label");k.textContent="Location: "+a.location;var l=document.createElement("label");l.textContent="Battery: "+(isNaN(a.battery)?"Unknown":100*a.battery+"%");var m=document.createElement("div");m.setAttribute("class","blog-divider");f.appendChild(g);e.appendChild(h);e.appendChild(document.createElement("br"));e.appendChild(document.createElement("br"));e.appendChild(k);e.appendChild(document.createElement("br"));
e.appendChild(document.createElement("br"));e.appendChild(l);d.appendChild(f);d.appendChild(e);c.appendChild(d);c.appendChild(m);if(!0===isTouchSupported)(new Hammer(c)).on("panright panend",function(a){switch(a.type){case "panright":d.style.marginLeft=a.deltaX+"px";break;case "panend":150<a.deltaX?(d.style.marginLeft="150px",confirmToDeleteBlog(b,c,d)):d.style.marginLeft="0px"}});return c}
function confirmToDeleteBlog(a,b,c){vibrateDevice();setTimeout(function(){1==confirm("Delete this photo blog?")?null!=blogs&&blogs.length>a&&(1==blogs.length&&0==a?blogs=[]:blogs.splice(a,1),blogDiv.removeChild(b),saveDataToLocalStorage()):c.style.marginLeft="0px"},200)}function vibrateDevice(){!0===isVibrationSupported&&navigator.vibrate(200)}
function saveDataToLocalStorage(){!0===isLocalStorageSupported&&(null!=blogs&&0<blogs.length?localStorage.setItem("blogs",JSON.stringify(blogs.slice(-Math.min(blogs.length,5)))):localStorage.setItem("blogs",JSON.stringify([])))}function getLocalSavedBlogs(){if(!0===isLocalStorageSupported&&(blogs=JSON.parse(localStorage.getItem("blogs")),null!=blogs&&0<blogs.length)){hideNoBlogLabel();for(var a=0;a<blogs.length;a++){var b=createBlogRow(blogs[a],a);blogDiv.appendChild(b)}}}var locationInput=null;
function configLocation(){locationInput=document.getElementById("locationInput");var a=document.getElementById("locationSwitch");showLocationInput(a.checked);a.addEventListener("change",function(){this.checked?!0===isGeoLocationSupported?(a.disabled=!0,showLocationInput(!0),locationInput.placeholder="Loading Location...",navigator.geolocation.getCurrentPosition(function(b){a.disabled=!1;showLocationInfo(b.coords.latitude,b.coords.longitude)},function(b){a.disabled=!1;var c={0:"Unknown error",1:"Permission denied by user",
2:"Position is not available",3:"Request timed out"}[b.code];if(0==b.code||2==b.code)c+=": "+b.message;showLocationInput(!0,c);locationInput.placeholder="Input Location"})):showLocationInput(!0,"Geolocation function is not supported"):showLocationInput(!1)})}
var showLocationInput=function(a,b){var c=document.getElementById("inputLocationDiv"),d=document.getElementById("locationSupportInfo");!0===a?(c.style.display="block",d.textContent=null!=b?b:""):(c.style.display="none",document.getElementById("locationInput").value="",d.textContent="")},showLocationInfo=function(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var a=JSON.parse(this.responseText);a&&a.results&&0<a.results.length&&((a=a.results[0])&&
a.formatted_address&&""!=a.formatted_address?locationInput.value=a.formatted_address:document.getElementById("locationSupportInfo").textContent="Cannot get address information")}locationInput.placeholder="Input Location"};c.open("GET","https://maps.googleapis.com/maps/api/geocode/json?latlng="+a+","+b+"&key=AIzaSyBYE5sFTGdc4L3lp9Qe_N2wxtFRl26UKzQ",!0);c.send()},batteryLevel=-1;
function configBattery(){!0===isBatterySupported?navigator.getBattery().then(function(a){var b=document.getElementById("batteryLabel");document.getElementById("batteryMeter").value=a.level;b.textContent=100*a.level+"%";batteryLevel=a.level}):document.getElementById("batteryDiv").style.display="none"};